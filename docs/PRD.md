# 水文数据库应用系统产品需求文档 (PRD)

**版本：** 1.2 (最终定稿)
**定稿日期：** 2025年8月21日
**产品经理：** John (BMAD-Method PM)

---

## 1. 目标与背景上下文

### 目标

* **核心业务目标**: 提供一个易于使用的界面，让水文技术人员能够便捷地访问、查看和维护基础水文数据库。
* **用户体验目标**: 将操作模式从传统的以“表”为中心，简化为以“测站”为核心实体，使其更贴近水文技术人员的工作流程。
* **功能扩展目标**: 提供针对水文数据特性的高级功能，例如时间尺度切换、批量数据维护和质量检查。
* **最终愿景**: 成为水文行业技术人员最信赖、最便捷的水文数据应用平台。

### 背景上下文

当前，水文行业的技术人员在使用通用数据库管理系统（DBMS）时，普遍面临操作复杂、效率低下的问题。尽管市面上存在如 `mayfly-go` 这样的通用在线数据库管理工具，但它们并未针对水文数据的独特性和技术人员的特定工作流进行优化。本项目旨在通过开发一个专为水文技术人员设计的应用系统，显著降低数据操作门槛，提升数据管理与维护的效率和便捷性。

我们决定基于 `mayfly-go` 进行二次开发，这将使我们能够复用其成熟的底层架构和通用功能，从而将开发资源集中在解决水文领域的特定痛点上。

`mayfly-go`开源项目地址：https://github.com/dromara/mayfly-go
`mayfly-go`开源项目文档：https://www.yuque.com/may-fly/mayfly-go

### 变更日志

| 日期 | 版本 | 描述 | 作者 |
| :--- | :--- | :--- | :--- |
| 2025年8月21日 | 1.2 | 根据最终反馈重构史诗3的故事。最终定稿。 | John (PM) |
| 2025年8月20日 | 1.1 | 根据反馈修订史诗1和3的验收标准。 | John (PM) |
| 2025年8月20日 | 1.0 | 初始草稿创建并根据多轮反馈完成 | John (PM) |

---

## 2. 需求 (Requirements)

### 功能性需求 (Functional Requirements)

* **FR1**: 系统必须提供一个**以“测站”为核心的查询视图**，作为水文数据显示和交互的主要界面。用户必须能通过测站编码 (`STCD`) 或名称进行便捷的搜索。
* **FR2**: 在测站视图中，当用户切换不同的时间尺度（如日、月、年）时，系统必须提供与之匹配的、便捷的时间段筛选功能。具体要求如下：
    * **按年尺度查看时**：提供年份选择器。
    * **按月尺度查看时**：提供年份和月份选择器。
    * **按日或更小尺度查看时**：提供日期范围选择器。
* **FR3**: 查询结果的数据表格应具备标准功能，包括按列排序、条件筛选和数据导出（CSV格式）。在开发中应优先复用 `mayfly-go` 的现有组件和能力来实现。
* **FR4**: 系统必须提供一个专业的数据维护工具，支持从文件或另一个数据库连接进行批量数据导入。
* **FR5**: 批量导入功能必须能够根据用户选择的测站、水文要素和时间尺度，利用预设的映射关系，自动将数据写入正确的目标数据表。
* **FR6**: 数据维护工具必须支持根据测站、年份和要素等条件对数据进行批量删除和批量更新。
* **FR7**: 所有批量操作（导入、删除、更新）执行前，系统必须提供清晰的二次确认或数据预览，以防止误操作。
* **FR8**: 系统必须依赖一个核心配置表 (`hytableinfo`) 来存储水文数据表的元数据。这些元数据必须包含但不限于：水文要素、时间尺度与具体物理数据表名、关键字段名之间的映射关系。

### 非功能性需求 (Non-Functional Requirements)

* **NFR1**: **用户体验**: 界面设计必须简洁直观，深度贴合水文技术人员的工作习惯与操作流程。
* **NFR2**: **可扩展性**: 系统架构必须支持未来新功能模块（如数据目录、质量检查引擎）和新数据类型的平滑扩展。
* **NFR3**: **可靠性与数据完整性**: 系统必须确保所有数据操作的原子性，保证数据的安全与完整。批量操作必须具备回滚机制或提供清晰的操作日志。
* **NFR4**: **可审计性**: 所有对数据的修改操作（增、删、改）都必须被详细记录，形成可追溯的审计追踪。

---

## 3. 用户界面设计目标

### 3.1 总体用户体验 (UX) 愿景

我们的UX愿景是打造一个**专业、高效、且无干扰**的数据工具。用户应该感觉到这是一个专为他们量身定制的“瑞士军刀”，而不是一个需要学习和适应的通用软件。所有的交互设计都应服务于一个核心目标：**最大程度地减少用户在找到和维护数据过程中的认知负荷和操作步骤**。

### 3.2 关键交互范式

* **测站为核心 (Station-Centric)**: 这是我们产品的基石。用户的绝大多数操作旅程都应始于“选择一个测站”。
* **直接操作 (Direct Manipulation)**: 用户在查看数据表格时，应感觉可以直观地对其进行操作。
* **向导式工作流 (Wizard-based Workflow)**: 对于批量导入/更新等复杂的、多步骤的数据维护任务，系统应提供清晰的、分步的向导界面。

### 3.3 核心屏幕与视图 (MVP)

1.  **主页 / 测站搜索页**
2.  **测站数据核心视图**
3.  **批量数据维护工具**

### 3.4 可访问性 (Accessibility)

* **标准**: 遵循 **WCAG AA** 标准。

### 3.5 品牌与风格 (Branding)

* **初步设想**: 沿用 `mayfly-go` 项目现有的 Element Plus 设计风格和组件库。

### 3.6 目标设备与平台 (Target Platforms)

* **平台**: **响应式网页 (Web Responsive)**。

---

## 4. 技术假设

### 4.1 仓库结构 (Repository Structure)

* **决策**: **单体仓库 (Monorepo)**
* **理由**: 与 `mayfly-go` 现有结构保持一致，便于复用与协同。

### 4.2 服务架构 (Service Architecture)

* **决策**: **模块化单体 (Modular Monolith)**
* **理由**: 延续 `mayfly-go` 的后端架构，将新功能作为模块集成。

### 4.3 测试要求 (Testing Requirements)

* **决策**: **单元测试 + 集成测试 (Unit + Integration)**
* **理由**: 保证代码质量和功能稳定性的行业标准实践。

### 4.4 其他技术假设

* **核心技术栈**: 完全继承 `mayfly-go` 的技术栈 (Go, Gin, GORM, Vue 3, TypeScript, Element Plus)。
* **数据库兼容性**: 与 `mayfly-go` 支持的主流数据库保持兼容。
* **部署方式**: 沿用 `mayfly-go` 的部署方式（可能基于Docker容器）。

---

## 5. 史诗列表 (Epic List)

* **史诗 1: MVP Part 1 - 交互式水文数据查询平台 (Interactive Hydrological Data Query Platform)**
    * **目标**: **快速交付**一个以测站为核心的**只读**数据查询工具，提供便捷的时间尺度切换功能，首先解决用户“查看数据难”的核心痛点。

* **史诗 2: MVP Part 2 - 专业化数据维护工具 (Professional Data Maintenance Tools)**
    * **目标**: 在数据查询平台的基础上，提供强大的批量数据导入、更新和删除功能，解决用户“维护数据难”的核心痛点。

* **史诗 3: V2.0 - 数据洞察与质量保障 (Data Insights & Quality Assurance)**
    * **目标**: 引入自动化数据目录和可配置的质量检查引擎，从“管理数据”提升到“保障数据质量”。

---

## 6. 史诗详情 (Epic Details)

### 史诗 1: MVP Part 1 - 交互式水文数据查询平台

**扩展目标**: 此史诗的目标是交付产品的第一个核心价值——一个以测站为中心的交互式查询界面。完成此史诗后，水文技术人员将能够彻底摆脱传统DBMS的复杂操作，首次体验到专为他们设计的数据查询流程。

#### 用户故事

* **故事 1.1: 基础集成与测站搜索功能**
    * **作为一个** 水文技术人员, **我想要** 在系统中看到一个专属的水文应用入口，并能通过一个简单的搜索框按站码或站名查找测站, **以便** 我能快速定位到我需要操作的目标测站。
    * **验收标准**:
        1.  系统左侧主菜单中出现一个新的一级菜单，名为“水文应用”。
        2.  点击后加载“测站查询”页面，包含搜索框和查询按钮。
        3.  查询后下方表格中会列出所有匹配的测站列表。
        4.  点击测站列表中的任意一行，页面会跳转到该测站的“数据核心视图”。

* **故事 1.2: 实现水文要素选择并展示默认数据**
    * **作为一个** 水文技术人员, **我想要** 在选择了某个测站后，系统能清晰地列出该站所有可用的“水文要素”，并默认加载其中一项要素的数据, **以便** 我能明确地知道这个站有哪些数据，并能快速开始查看。
    * **验收标准**:
        1.  在“数据核心视图”页面，必须有一个清晰的**水文要素选择器**。
        2.  页面首次加载时，默认选中第一个水文要素。
        3.  数据表格会加载并显示**当前选中要素**的默认（日）数据。
        4.  数据默认显示最近30天。
        5.  用户点击选择器中的其他要素，数据表格会立刻刷新，以显示新选中要素的数据。

* **故事 1.3: 核心功能 - 时间尺度切换**
    * **作为一个** 水文技术人员, **我想要** 在查看**某一特定水文要素**的数据时，能通过一组简单的控件在不同时间尺度间切换, **以便** 我能对这项要素的数据进行多维度、多粒度的对比和分析。
    * **验收标准**:
        1.  提供清晰的时间尺度切换控件（如一组按钮：“日”、“月”、“年”）。
        2.  切换时间尺度后，数据表格会重新加载并显示**当前选中水文要素**在对应时间尺度下的数据。
        3.  当前选中的时间尺度在界面上有明确的视觉高亮提示。

* **故事 1.4: 智能时间段筛选**
    * **作为一个** 水文技术人员, **我想要** 系统能根据我所选择的时间尺度，自动为我提供最合适的日期筛选工具, **以便** 我能用最符合直觉的方式，精确地筛选出我感兴趣的时间范围内的数据。
    * **验收标准**:
        1.  当时间尺度为“年”时，日期筛选工具应变为一个年份选择器。
        2.  当时间尺度为“月”时，日期筛选工具应变为一个年份选择器和一个月份选择器。
        3.  当时间尺度为“日”时，日期筛选工具应变为一个日期范围选择器。
        4.  调整筛选条件后，数据表格会根据新的时间范围刷新。

### 史诗 2: MVP Part 2 - 专业化数据维护工具

**扩展目标**: 此史诗旨在交付一个向导式的、智能的数据维护工具。它将复杂的批量数据操作流程简化为几个简单的步骤，并通过强大的后端逻辑和预设配置，自动处理数据表的映射，极大地降低了数据维护工作的复杂度和出错风险。

#### 用户故事

* **故事 2.1: 批量维护工具的入口与数据源选择**
    * **作为一个** 水文技术人员, **我想要** 一个专门的“批量数据维护”功能入口，进入后可以选择我的数据来源（文件或数据库）, **以便** 我能开始批量数据操作的第一步。
    * **验收标准**:
        1.  在“水文应用”菜单下，出现一个新的子菜单项“批量维护”。
        2.  页面提供两个数据源选项：“文件上传”（初期仅支持CSV）和“数据库连接”。

* **故事 2.2: 目标映射与操作预览**
    * **作为一个** 水文技术人员, **我想要** 在提供了数据源后，能够指定这批数据的目标测站、水文要素和时间尺度，并能预览系统的操作计划, **以便** 我能确保数据会被准确地写入到正确的位置。
    * **验收标准**:
        1.  向导进入第二步“目标映射”，提供测站、水文要素、时间尺度的选择。
        2.  “时间尺度”选择器应仅提供“年”和“月”两个选项。
        3.  界面需要提供一个输入框，让用户指定数据的目标时间点（例如 `2024` 或 `202405`）。
        4.  系统会根据用户的选择和 `hytableinfo` 配置，明确显示将要操作的物理数据表名。
        5.  系统提供源数据预览和操作摘要供用户确认。

* **故事 2.3: 批量导入的执行、监控与日志**
    * **作为一个** 水文技术人员, **我想要** 在确认操作后，系统能安全地执行批量导入，并为我提供操作进度反馈和一份详细的结果日志, **以便** 我能了解操作是否成功。
    * **验收标准**:
        1.  导入过程为异步后台任务，界面提供进度反馈。
        2.  任务完成后，提供结果摘要和可下载的详细日志。

* **故事 2.4: 批量删除与更新功能**
    * **作为一个** 数据管理员, **我想要** 在批量维护工具中，也能方便地执行批量删除和批量更新操作, **以便** 我能高效地修正或清理大批量的数据。
    * **验收标准**:
        1.  工具提供“导入”、“更新”、“删除”的功能切换。
        2.  “删除”和“更新”功能的时间范围输入框必须支持格式化文本输入（年: `2000-2005`, 月: `202003-202502`）。
        3.  删除操作前有二次强确认。
        4.  所有写操作都必须记入审计日志。

### 史诗 3: V2.0 - 数据洞察与质量保障

**扩展目标**: 此史诗的目标是为用户提供自动化和智能化的数据管理能力。通过自动生成的数据目录，用户可以即时了解测站的数据资产情况。通过可配置的质量检查引擎，用户可以将专业的水文数据审查知识固化为自动化规则，从而系统性地提升数据的准确性和可靠性。

#### 用户故事

* **故事 3.1: 测站数据资料目录自动生成**
    * **作为一个** 水文技术人员, **我想要** 系统能够自动扫描并生成一份关于某个测站的“数据资料目录”, **以便** 我能快速、完整地了解这个测站的数据覆盖情况。
    * **验收标准**:
        1.  在“数据核心视图”页面，增加一个名为“数据目录”的标签页。
        2.  目录中的“数据覆盖范围”列必须能准确地反映数据在时间上的**不连续性**，通过逗号分隔多个连续的时间段。
        3.  数据覆盖范围的**显示格式**必须遵循以下规范：
            * **年度覆盖范围**: `YYYY-YYYY` (例如: `1985-2001, 2003-2023`)。
            * **月度覆盖范围**: `YYYYMM-YYYYMM` (例如: `202003-202112, 202301-202312`)。
        4.  例如，一条日尺度表的目录条目应展示为：“要素: 水位, 尺度: 日, 表名: st_river_r_day, 年度覆盖: 1985-2001, 2003-2023, 月度覆盖: 198501-200112, 202301-202312”。
        5.  提供“刷新”按钮。

* **故事 3.2: 数据质量检查“规则模板”管理**
    * **作为一个** 高级水文技术人员, **我想要** 一个用户界面，让我可以定义和管理**抽象的“规则模板”**（例如：“历史极值范围检查”), **以便** 我能将我们团队通用的数据审查方法论固化到系统中。
    * **验收标准**:
        1.  提供“数据质量中心”及“规则管理”页面。
        2.  UI支持通过表单创建、编辑、删除“规则模板”，定义其名称、要素类型、检查类型等，但无需输入具体参数。

* **故事 3.3: 基于历史数据的自动化规则生成**
    * **作为一个** 数据管理员, **我想要** 系统能利用一个“规则模板”，通过扫描**特定测站**的历史数据，来**自动生成**一条条具体的、带参数的检查规则, **以便** 我能快速地为成百上千个测站创建出个性化的检查规则。
    * **验收标准**:
        1.  提供一个“规则生成”功能，允许用户选择测站和规则模板。
        2.  系统为每个选定的测站，根据其历史数据自动计算出规则所需的参数（如历史最大/最小值）。
        3.  系统自动创建出具体的、与测站关联的规则实例。

* **故事 3.4: 执行数据质量检查并查看报告**
    * **作为一个** 水文技术人员, **我想要** 能够在选定测站后，能够运行**系统为其自动生成的**或手动配置的质量检查规则，并查看结果报告, **以便** 我能快速定位到数据中可能存在的错误。
    * **验收标准**:
        1.  在“数据核心视图”页面，提供“执行质量检查”功能。
        2.  允许用户选择适用于当前测站的规则实例和时间范围来执行检查。
        3.  检查为异步后台任务，完成后提供摘要报告和可导出的详细问题清单。

---
